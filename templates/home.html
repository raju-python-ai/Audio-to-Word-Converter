<!DOCTYPE html>
<html lang="{{ 'ta' if lang == 'tamil' else 'en' }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ t["title"] }}</title>
  <!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap Bundle JS (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <link rel="stylesheet" href="../static/css/mainpage.css">
 <!-- Font Awesome CDN -->
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
  integrity="sha512-KN3xGd/7QMyW+r9E3lsG3UHrSLb9mO2+Jrh6nZ1JgA7YhXn9LZBL+JPhdKc2f9nVjI+O7bI8fy0uqSm5f2p7xg=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"/>


  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
<meta name="theme-color" content="#ffffff">


</head>
<body>

  <div class="header">
  <button class="btn" type="button" id="menuButton">
    <i class="fas fa-bars"></i> <!-- FontAwesome hamburger icon -->
  </button>
  <div class="logo">{{ t["appName"] }}</div>
</div>
<div class="background-image"></div> 


<div id="mainContent" class="main-content">
    <div class="upload-card">
      <div class="card-title">
        <span class="wave-icon"></span> {{ t["title"] }}
      </div>

      <form id="uploadForm" enctype="multipart/form-data">
        <!-- File + Mic row -->
          <div class="file-record-row">
              <input type="file" id="audioInput" name="audio" accept="audio/*" style="display:none;">
              <button type="button" id="fileButton"><span class="file-icon"><i class="fa-solid fa-folder-open"></i></span> {{ t['choose_file'] }}</button>        
              <button type="button" class="record-btn" id="recordBtn"><i class="fa-solid fa-microphone-lines"></i></button>
          </div>
          <br>
          <div id="selectedFileName" style="margin-bottom: 5px;"></div>

            <!-- Transcribed text box -->
          <div class="textbox-container" style="position: relative;">
            <textarea id="transcribedText" placeholder="{{ t['transcribed_placeholder'] }}" required></textarea>
            <!-- <button type="button" id="clearTextBtn" style="display:none; position:absolute; bottom:5px; right:5px;">Clear</button> -->
          </div>
          <button type="button" id="clearTextBtn">{{ t["Clear"] }}</button>
          
            <!-- Convert button -->
            <button type="submit" id="convertBtn" disabled>{{ t["convert"] }}</button>
      </form>

      <div id="status"></div>
    </div>
</div>
    
  <div class="popup-overlay" id="formatPopup">
    <div class="popup-content">
      <div class="card">
        <h2>{{ t["select_format"] }}</h2>

        <div class="file-option">
          <img src="https://img.icons8.com/color/48/000000/ms-word.png" alt="Word Icon">
          <div class="file-label">Word File</div>
          <button class="btn btn-grey" id="downloadWord">‡Æ™‡Æ§‡Æø‡Æµ‡Æø‡Æ±‡Æï‡Øç‡Æï</button>
        </div>

        <div class="file-option">
          <img src="https://img.icons8.com/color/48/000000/pdf.png" alt="PDF Icon">
          <div class="file-label">PDF File</div>
          <button class="btn btn-red" id="downloadPDF">‡Æ™‡Æ§‡Æø‡Æµ‡Æø‡Æ±‡Æï‡Øç‡Æï</button>
        </div>
      </div>
    </div>
  </div>

    <!-- Injected alerts -->
    <script id="alerts-data" type="application/json">
      {{ t["alerts"] | tojson | safe }}
    </script>

    <script>
  if ("service" in navigator) {
    window.addEventListener("load", function() {
      navigator.serviceWorker.register("{{ url_for('static', filename='service-worker.js') }}")
        .then(() => console.log("Service Worker registered!"))
        .catch(err => console.log("SW registration failed:", err));
    });
  }
</script>
  </div>

  <div id="sidebar" class="sidebar">
    <!-- Main Sidebar -->
    <div id="sidebarMain">
      <div class="sidebar-header">
        <span></span>
        <span class="close-btn" onclick="closeMenu()"><i class="fa-solid fa-circle-xmark"></i></span>
      </div>
      <a href="/dashboard" class="menu-item"><i class="fa-solid fa-square-poll-vertical"></i> <span>{{ t["dashboard"] }}</span></a>
      <a href="/history" class="menu-item"><i class="fa-solid fa-layer-group"></i>  <span>{{ t["history"] }}</span></a>
      <a href="{{ url_for('main.home') }}" class="menu-item"><i class="fa-solid fa-house"></i><span>{{ t["home"] }}</span></a>
      <a href="#" class="menu-item" onclick="showSidebarSettings()"><i class="fa-solid fa-gear"></i> <span>{{ t["settings"] }}</span></a>
      <a href="{{ url_for('auth.logout') }}" class="menu-item"><i class="fa-solid fa-right-from-bracket"></i> <span>{{ t["logout"] }}</span></a>
    </div>

    <!-- Settings Sidebar -->
    <div id="sidebarSettings" style="display:none;">
      <div class="sidebar-header">
        <button class="back-btn" onclick="showSidebarMain()"> <i class="fa-solid fa-left-long"></i></button>
      </div>
      <a href="{{ url_for('settings.settings_page', page='account') }}" class="menu-item"><i class="fa-solid fa-circle-user"></i> <span>{{ t["account"] }}</span></a>
      <a href="/settings/lang_select" class="menu-item"><i class="fa-solid fa-language"></i> <span>{{ t["language"] }}</span></a>
      <a href="/settings/version" class="menu-item"><i class="fa-solid fa-screwdriver-wrench"></i> <span>{{ t["version"] }}</span></a>
    </div>
  </div>
  <script>
const menuButton = document.getElementById('menuButton');
  menuButton.addEventListener('click', () => {
    openMenu(); // call your existing openMenu function
  });
   function openMenu() {
  document.getElementById("sidebar").style.width = "250px";
}

function closeMenu() {
  document.getElementById("sidebar").style.width = "0";
}

// Show Settings sidebar
function showSidebarSettings() {
  document.getElementById("sidebarMain").style.display = "none";
  document.getElementById("sidebarSettings").style.display = "block";
}

// Show Main sidebar
function showSidebarMain() {
  document.getElementById("sidebarSettings").style.display = "none";
  document.getElementById("sidebarMain").style.display = "block";
}
    document.addEventListener("DOMContentLoaded", () => {
  const alerts = JSON.parse(document.getElementById("alerts-data").textContent);
  const form = document.getElementById("uploadForm");
  const fileInput = document.getElementById("audioInput");
  const fileButton = document.getElementById("fileButton");
  const status = document.getElementById("status");
  const popup = document.getElementById("formatPopup");
  const btnWord = document.getElementById("downloadWord");
  const btnPDF = document.getElementById("downloadPDF");
  const recordBtn = document.getElementById("recordBtn");
  const convertBtn = document.getElementById("convertBtn");
  const textBox = document.getElementById("transcribedText");
  const clearBtn = document.getElementById("clearTextBtn");
  const selectedFileNameDiv = document.getElementById("selectedFileName");
// let selectedFile = null;

  let selectedFile = null;
  let mediaRecorder = null;
  let recordedChunks = [];
  let justCleared = false;

  // ---------------- Voice Recording ----------------
  recordBtn.addEventListener("click", async () => {
    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
      recordBtn.textContent = "üé§";
      return;
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recordedChunks = [];
      mediaRecorder = new MediaRecorder(stream);

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        if (recordedChunks.length === 0) {
          alert("No audio recorded");
          return;
        }

        selectedFile = new File([new Blob(recordedChunks, { type: "audio/wav" })], "record.wav", { type: "audio/wav" });
        fileInput.value = "";
        justCleared = false;
        transcribeAudio(selectedFile);
        updateClearButton();
      };

      mediaRecorder.start();
      recordBtn.textContent = "‚èπ";
      status.innerText = alerts.processing;

    } catch (err) {
      console.error(err);
      alert(alerts.mic_error);
    }
  });

  fileButton.addEventListener("click", () => {
    fileInput.click(); // open file dialog
});
  // ---------------- Manual File Upload ----------------
  fileInput.addEventListener("change", () => {
     if (fileInput.files.length > 0) {
        selectedFile = fileInput.files[0];
        selectedFileNameDiv.textContent = selectedFile.name; // show name in div above buttons
        justCleared = false;
        transcribeAudio(selectedFile); // start transcription
    } else {
        selectedFile = null;
        selectedFileNameDiv.textContent = ""; // clear name if no file
    }
    updateClearButton();
  });

  // ---------------- Transcription ----------------
  async function transcribeAudio(file) {
    if (justCleared) return;

    status.innerText = alerts.processing;
    convertBtn.disabled = true;
    textBox.value = "";

    const formData = new FormData();
    formData.append("audio", file);

    try {
        const res = await fetch("/upload", { method: "POST", body: formData });
        const data = await res.json();
        console.log("Transcription response:", data);

        if (!res.ok || !data.text) {
            status.innerText = alerts.error;
            setTimeout(() => status.innerText = "", 5000); // hide after 5 seconds
            return;
        }

        textBox.value = data.text;
        status.innerText = alerts.done;
        setTimeout(() => status.innerText = "", 5000); // keep done message for 5 seconds
        convertBtn.disabled = false;
        updateClearButton();

    } catch (err) {
        console.error(err);
        status.innerText = alerts.error;
        setTimeout(() => status.innerText = "", 5000); // hide after 5 seconds
    }
}
  // ---------------- Convert Button & Popup ----------------
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    if (!textBox.value.trim()) {
      alert(alerts.no_text);
      return;
    }
    popup.style.display = "flex";
  });

  btnWord.addEventListener("click", () => handleDownload("docx"));
  btnPDF.addEventListener("click", () => handleDownload("pdf"));

  async function handleDownload(format) {
    popup.style.display = "none";
    status.innerText = alerts.processing;

    const text = textBox.value.trim();
    if (!text) {
        alert(alerts.no_text);
        status.innerText = "";
        return;
    }

    const formData = new FormData();
    formData.append("text", text);
    formData.append("format", format);

    try {
        const res = await fetch("/convert", { method: "POST", body: formData });
        if (!res.ok) {
            status.innerText = alerts.error;
            setTimeout(() => status.innerText = "", 5000); // hide after 5 seconds
            return;
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = format === "pdf" ? "tamil_transcript.pdf" : "tamil_transcript.docx";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        status.innerText = alerts.done;
        setTimeout(() => status.innerText = "", 5000); // keep done message for 5 seconds

    } catch (err) {
        console.error(err);
        status.innerText = alerts.error;
        setTimeout(() => status.innerText = "", 5000); // hide after 5 seconds
    }
}

  // ---------------- Clear Button ----------------
  function updateClearButton() {
    if (textBox.value.trim() || selectedFile) {
      clearBtn.style.display = "block";
    } else {
      clearBtn.style.display = "none";
    }
  }

  clearBtn.addEventListener("click", () => {
    textBox.value = "";
    selectedFile = null;
    fileInput.value = "";
    convertBtn.disabled = true;
    clearBtn.style.display = "none";
    selectedFileNameDiv.style.display = "none";
    justCleared = true;
  });

  // ---------------- Textarea input ----------------
  textBox.addEventListener("input", () => {
    updateClearButton();
    convertBtn.disabled = !textBox.value.trim();
  });

  // ---------------- Hide popup when clicking outside ----------------
  popup.addEventListener("click", (e) => {
    if (e.target === popup) popup.style.display = "none";
  });
});

  </script>
</body>
</html>


